name: Build/push docker image

on:
    push:
        branches:
            - 'auto-docker-build'
        tags:
            - '*' # all tags without '/'

jobs:
    publish-docker:
        env:
            IMAGE_NAME: fortune9/auto-hello
        runs-on: ubuntu-latest
        steps:
            - name: checkout
              uses: actions/checkout@v3
            - name: login dockerhub
              env:
                  DH_USER: ${{ secrets.DOCKERHUB_USER }}
                  DH_PASS: ${{ secrets.DOCKERHUB_PASSWORD }}
              run: |
                  docker login -u "$DH_USER" -p "$DH_PASS"
            - name: Get docker meta
              id: meta
              uses: docker/metadata-action@v4
              with:
                  images: "${{ env.IMAGE_NAME }}"
                  tags:
                    type=ref,event=tag
                  #- name: Build image
                  #run docker build . --file Dockerfile
            - name: Show docker meta
              if: ${{ steps.meta.outputs.tags != "" }}
              id: show_meta
              run: |
                  echo "Tags: ${{ steps.meta.outputs.tags }}"
                  echo "Labels: ${{ steps.meta.outputs.labels }}"
                  # USE $GITHUB_ENV to share environment variables
                  # across steps
                  echo "REPO_TAG=${{ steps.meta.outputs.version }}" >> $GITHUB_ENV
                  #echo "::set-output name=REPO_TAG::${{ steps.meta.outputs.tags[0].name }}"
            - name: Build and push docker
              run: |
                  #docker build -t $IMAGE_NAME:$REPO_TAG .
                  #docker image push $IMAGE_NAME:$REPO_TAG
                  echo "I can see REPO_TAG as $REPO_TAG"
                  echo "I can see steps.show_meta.outputs.REPO_TAG as ${{ steps.show_meta.outputs.REPO_TAG }}"

